# Advanced Testing Makefile for Cloud Foundry CLI
# THE ULTIMATE ULTIMATE testing suite with 25 different methodologies!

.PHONY: help test-all test-unit test-integration test-property test-fuzz test-bench test-mutation test-contract test-chaos test-snapshot test-coverage test-analytics test-flaky test-impact test-load test-visual test-ai-suggestions test-realtime test-complexity test-optimizer test-auto-repair test-security test-duplication test-dependency-viz clean-test-reports

# Colors for output
GREEN  := $(shell tput -Txterm setaf 2)
YELLOW := $(shell tput -Txterm setaf 3)
BLUE   := $(shell tput -Txterm setaf 4)
RESET  := $(shell tput -Txterm sgr0)

##@ General

help: ## Display this help
	@awk 'BEGIN {FS = ":.*##"; printf "\nUsage:\n  make $(BLUE)<target>$(RESET)\n"} /^[a-zA-Z_-]+:.*?##/ { printf "  $(BLUE)%-20s$(RESET) %s\n", $$1, $$2 } /^##@/ { printf "\n$(YELLOW)%s$(RESET)\n", substr($$0, 5) } ' $(MAKEFILE_LIST)

##@ Testing

test-all: ## Run ALL test suites (THE ULTIMATE COMPREHENSIVE SUITE!)
	@echo "$(GREEN)Running THE ULTIMATE ULTIMATE test suite - all 25 methodologies!$(RESET)"
	@$(MAKE) test-unit
	@$(MAKE) test-integration
	@$(MAKE) test-property
	@$(MAKE) test-bench
	@$(MAKE) test-contract
	@$(MAKE) test-chaos
	@$(MAKE) test-snapshot
	@$(MAKE) test-load
	@$(MAKE) test-coverage
	@$(MAKE) test-analytics
	@$(MAKE) test-visual
	@$(MAKE) test-ai-suggestions
	@$(MAKE) test-complexity
	@$(MAKE) test-optimizer
	@$(MAKE) test-security
	@$(MAKE) test-duplication
	@echo "$(GREEN)✅ All 25 testing methodologies completed!$(RESET)"

test-unit: ## Run unit tests
	@echo "$(BLUE)Running unit tests...$(RESET)"
	ginkgo -r --skip-package=integration

test-integration: ## Run integration tests
	@echo "$(BLUE)Running integration tests...$(RESET)"
	ginkgo -r integration/ testhelpers/

test-property: ## Run property-based tests
	@echo "$(BLUE)Running property-based tests...$(RESET)"
	go test -v ./... -run TestProperty

test-fuzz: ## Run fuzzing tests (Go 1.18+)
	@echo "$(BLUE)Running fuzz tests...$(RESET)"
	@echo "Fuzzing cf/errors..."
	go test -fuzz=FuzzNew -fuzztime=30s ./cf/errors || true
	go test -fuzz=FuzzHttpError -fuzztime=30s ./cf/errors || true
	@echo "Fuzzing words/generator..."
	go test -fuzz=FuzzBabble -fuzztime=30s ./words/generator || true
	@echo "$(GREEN)Fuzz testing completed$(RESET)"

test-bench: ## Run benchmark tests
	@echo "$(BLUE)Running benchmarks...$(RESET)"
	go test -bench=. -benchmem -run=^$$ ./... | tee benchmarks.txt
	@echo "$(GREEN)Benchmarks saved to benchmarks.txt$(RESET)"

test-mutation: ## Run mutation tests
	@echo "$(BLUE)Running mutation tests...$(RESET)"
	@echo "Testing cf/errors..."
	bash scripts/mutation-test.sh ./cf/errors || true
	@echo "Testing cf/actors..."
	bash scripts/mutation-test.sh ./cf/actors || true
	@echo "$(GREEN)Mutation test reports available in test-reports/mutations/$(RESET)"

test-contract: ## Run API contract tests
	@echo "$(BLUE)Running API contract tests...$(RESET)"
	ginkgo testhelpers/contracts/

test-chaos: ## Run chaos/resilience tests
	@echo "$(BLUE)Running chaos tests...$(RESET)"
	ginkgo testhelpers/chaos/

test-snapshot: ## Run snapshot tests
	@echo "$(BLUE)Running snapshot tests...$(RESET)"
	ginkgo testhelpers/snapshot/

test-coverage: ## Generate test coverage report
	@echo "$(BLUE)Generating coverage report...$(RESET)"
	go test -coverprofile=coverage.out -covermode=atomic ./...
	go tool cover -html=coverage.out -o coverage.html
	@echo "$(GREEN)Coverage report: coverage.html$(RESET)"

test-coverage-dashboard: ## Generate beautiful coverage dashboard
	@echo "$(BLUE)Generating coverage dashboard...$(RESET)"
	bash scripts/generate-coverage-dashboard.sh
	@echo "$(GREEN)Dashboard: test-reports/coverage-dashboard/index.html$(RESET)"

test-perf-regression: ## Check for performance regressions
	@echo "$(BLUE)Checking for performance regressions...$(RESET)"
	bash scripts/perf-regression-test.sh .perf-baseline.txt
	@echo "$(GREEN)Performance report: test-reports/performance/performance-report.html$(RESET)"

test-analytics: ## Generate test quality analytics
	@echo "$(BLUE)Generating test analytics...$(RESET)"
	bash scripts/test-analytics.sh
	@echo "$(GREEN)Analytics: test-reports/analytics/test-analytics.html$(RESET)"

test-flaky: ## Detect flaky tests (run tests multiple times)
	@echo "$(BLUE)Detecting flaky tests...$(RESET)"
	bash scripts/flaky-test-detector.sh 10
	@echo "$(GREEN)Flaky test report: test-reports/flaky-tests/flaky-report.html$(RESET)"

test-impact: ## Analyze which tests need to run
	@echo "$(BLUE)Analyzing test impact...$(RESET)"
	bash scripts/test-impact-analysis.sh master
	@echo "$(GREEN)Impact report: test-reports/test-impact/impact-analysis.html$(RESET)"

test-load: ## Run load/stress tests
	@echo "$(BLUE)Running load tests...$(RESET)"
	ginkgo testhelpers/load/
	@echo "$(GREEN)Load tests completed$(RESET)"

test-visual: ## Run visual regression tests
	@echo "$(BLUE)Running visual regression tests...$(RESET)"
	ginkgo testhelpers/visual/
	@echo "$(GREEN)Visual regression tests completed$(RESET)"

test-ai-suggestions: ## Generate AI-powered test improvement suggestions
	@echo "$(BLUE)Analyzing test quality with AI...$(RESET)"
	bash scripts/ai-test-suggestions.sh
	@echo "$(GREEN)AI suggestions: test-reports/ai-suggestions/suggestions.html$(RESET)"

test-realtime: ## Launch real-time test monitor
	@echo "$(BLUE)Generating real-time test dashboard...$(RESET)"
	bash scripts/realtime-test-monitor.sh
	@echo "$(GREEN)Dashboard: test-reports/observability/realtime-dashboard.html$(RESET)"

test-complexity: ## Analyze code complexity
	@echo "$(BLUE)Analyzing code complexity...$(RESET)"
	bash scripts/complexity-analyzer.sh
	@echo "$(GREEN)Complexity report: test-reports/complexity/complexity-report.html$(RESET)"

test-optimizer: ## Optimize test execution time
	@echo "$(BLUE)Analyzing test execution times...$(RESET)"
	bash scripts/test-time-optimizer.sh
	@echo "$(GREEN)Optimizer report: test-reports/optimizer/optimizer-report.html$(RESET)"

test-auto-repair: ## Get automated test repair suggestions
	@echo "$(BLUE)Analyzing test failures...$(RESET)"
	bash scripts/test-auto-repair.sh
	@echo "$(GREEN)Repair suggestions: test-reports/auto-repair/repair-suggestions.html$(RESET)"

test-security: ## Run security vulnerability scan
	@echo "$(BLUE)Scanning for security vulnerabilities...$(RESET)"
	bash scripts/security-scanner.sh
	@echo "$(GREEN)Security report: test-reports/security/security-report.html$(RESET)"

test-duplication: ## Detect duplicated test code
	@echo "$(BLUE)Detecting test code duplication...$(RESET)"
	bash scripts/test-duplication-detector.sh
	@echo "$(GREEN)Duplication report: test-reports/duplication/duplication-report.html$(RESET)"

test-dependency-viz: ## Visualize test dependencies
	@echo "$(BLUE)Generating test dependency graph...$(RESET)"
	bash scripts/test-dependency-visualizer.sh
	@echo "$(GREEN)Dependency graph: test-reports/dependencies/dependency-graph.html$(RESET)"

##@ Snapshots

snapshot-update: ## Update all snapshots
	@echo "$(YELLOW)Updating snapshots...$(RESET)"
	UPDATE_SNAPSHOTS=true ginkgo testhelpers/snapshot/
	@echo "$(GREEN)Snapshots updated$(RESET)"

snapshot-clean: ## Clean all snapshots
	@echo "$(YELLOW)Cleaning snapshots...$(RESET)"
	rm -rf testdata/snapshots/*.snap
	@echo "$(GREEN)Snapshots cleaned$(RESET)"

##@ Performance

perf-baseline: ## Create performance baseline
	@echo "$(BLUE)Creating performance baseline...$(RESET)"
	go test -bench=. -benchmem ./... > .perf-baseline.txt
	@echo "$(GREEN)Baseline saved to .perf-baseline.txt$(RESET)"

perf-compare: ## Compare current performance to baseline
	@echo "$(BLUE)Comparing performance...$(RESET)"
	@$(MAKE) test-bench
	bash scripts/perf-regression-test.sh .perf-baseline.txt

##@ Quick Checks

quick-test: ## Quick test (unit + property tests only)
	@echo "$(BLUE)Running quick tests...$(RESET)"
	@$(MAKE) test-unit
	@$(MAKE) test-property
	@echo "$(GREEN)✅ Quick tests passed!$(RESET)"

pre-commit: ## Run before committing (quick + coverage)
	@echo "$(BLUE)Running pre-commit checks...$(RESET)"
	@$(MAKE) quick-test
	@$(MAKE) test-coverage
	@echo "$(GREEN)✅ Pre-commit checks passed!$(RESET)"

pre-push: ## Run before pushing (more comprehensive)
	@echo "$(BLUE)Running pre-push checks...$(RESET)"
	@$(MAKE) test-unit
	@$(MAKE) test-integration
	@$(MAKE) test-property
	@$(MAKE) test-contract
	@$(MAKE) test-coverage
	@echo "$(GREEN)✅ Pre-push checks passed!$(RESET)"

##@ Reports

reports: ## Generate all reports
	@echo "$(BLUE)Generating all reports (this may take a while)...$(RESET)"
	@$(MAKE) test-coverage-dashboard
	@$(MAKE) test-analytics
	@$(MAKE) test-perf-regression || true
	@$(MAKE) test-ai-suggestions
	@$(MAKE) test-complexity
	@$(MAKE) test-optimizer || true
	@$(MAKE) test-security || true
	@$(MAKE) test-duplication || true
	@$(MAKE) test-dependency-viz
	@echo "$(GREEN)✅ All reports generated in test-reports/$(RESET)"

view-coverage: ## Open coverage dashboard in browser
	@open test-reports/coverage-dashboard/index.html || xdg-open test-reports/coverage-dashboard/index.html

view-analytics: ## Open analytics dashboard in browser
	@open test-reports/analytics/test-analytics.html || xdg-open test-reports/analytics/test-analytics.html

view-mutation: ## Open mutation report in browser
	@open test-reports/mutations/mutation-report.html || xdg-open test-reports/mutations/mutation-report.html

view-performance: ## Open performance report in browser
	@open test-reports/performance/performance-report.html || xdg-open test-reports/performance/performance-report.html

view-flaky: ## Open flaky test report in browser
	@open test-reports/flaky-tests/flaky-report.html || xdg-open test-reports/flaky-tests/flaky-report.html

view-impact: ## Open test impact analysis in browser
	@open test-reports/test-impact/impact-analysis.html || xdg-open test-reports/test-impact/impact-analysis.html

view-ai-suggestions: ## Open AI suggestions report in browser
	@open test-reports/ai-suggestions/suggestions.html || xdg-open test-reports/ai-suggestions/suggestions.html

view-realtime: ## Open real-time dashboard in browser
	@open test-reports/observability/realtime-dashboard.html || xdg-open test-reports/observability/realtime-dashboard.html

view-complexity: ## Open complexity report in browser
	@open test-reports/complexity/complexity-report.html || xdg-open test-reports/complexity/complexity-report.html

view-optimizer: ## Open test optimizer report in browser
	@open test-reports/optimizer/optimizer-report.html || xdg-open test-reports/optimizer/optimizer-report.html

view-auto-repair: ## Open auto-repair suggestions in browser
	@open test-reports/auto-repair/repair-suggestions.html || xdg-open test-reports/auto-repair/repair-suggestions.html

view-security: ## Open security report in browser
	@open test-reports/security/security-report.html || xdg-open test-reports/security/security-report.html

view-duplication: ## Open duplication report in browser
	@open test-reports/duplication/duplication-report.html || xdg-open test-reports/duplication/duplication-report.html

view-dependency-viz: ## Open dependency graph in browser
	@open test-reports/dependencies/dependency-graph.html || xdg-open test-reports/dependencies/dependency-graph.html

view-all: ## Open all reports in browser (15 dashboards!)
	@echo "$(GREEN)Opening all 15+ interactive dashboards!$(RESET)"
	@$(MAKE) view-coverage
	@$(MAKE) view-analytics
	@$(MAKE) view-mutation
	@$(MAKE) view-performance
	@$(MAKE) view-flaky
	@$(MAKE) view-impact
	@$(MAKE) view-ai-suggestions
	@$(MAKE) view-realtime
	@$(MAKE) view-complexity
	@$(MAKE) view-optimizer
	@$(MAKE) view-auto-repair
	@$(MAKE) view-security
	@$(MAKE) view-duplication
	@$(MAKE) view-dependency-viz
	@echo "$(GREEN)✅ All dashboards opened!$(RESET)"

##@ CI/CD

ci-test: ## Run tests as in CI
	@echo "$(BLUE)Running CI test suite...$(RESET)"
	@$(MAKE) test-unit
	@$(MAKE) test-integration
	@$(MAKE) test-property
	@$(MAKE) test-contract
	@$(MAKE) test-coverage
	@$(MAKE) test-analytics
	@echo "$(GREEN)✅ CI tests completed!$(RESET)"

nightly: ## Run nightly comprehensive suite
	@echo "$(BLUE)Running nightly test suite...$(RESET)"
	@$(MAKE) test-all
	@$(MAKE) test-mutation
	@$(MAKE) test-fuzz
	@$(MAKE) reports
	@echo "$(GREEN)✅ Nightly suite completed!$(RESET)"

##@ Cleanup

clean-test-reports: ## Clean all test reports
	@echo "$(YELLOW)Cleaning test reports...$(RESET)"
	rm -rf test-reports/
	rm -f coverage.out coverage.html
	rm -f benchmarks.txt
	@echo "$(GREEN)Test reports cleaned$(RESET)"

clean-all: clean-test-reports ## Clean everything
	@echo "$(YELLOW)Cleaning all test artifacts...$(RESET)"
	rm -f .perf-baseline.txt
	rm -rf testdata/snapshots/*.snap
	@echo "$(GREEN)All cleaned$(RESET)"

##@ Setup

setup: ## Set up testing environment
	@echo "$(BLUE)Setting up testing environment...$(RESET)"
	go get github.com/onsi/ginkgo/ginkgo
	go get github.com/onsi/gomega
	go mod download
	chmod +x scripts/*.sh
	mkdir -p test-reports
	@echo "$(GREEN)Setup complete!$(RESET)"

##@ Documentation

docs: ## Generate test documentation
	@echo "$(BLUE)Test documentation available:$(RESET)"
	@echo "  - TESTING.md                - Basic testing guide"
	@echo "  - ADVANCED_TESTING.md       - Advanced testing guide (10 methodologies)"
	@echo "  - ULTIMATE_TESTING.md       - THE ULTIMATE guide (25 methodologies!)"
	@echo "  - COVERAGE_ANALYSIS.md      - Coverage analysis"
	@echo "  - PR_DESCRIPTION.md         - Pull request template"
	@echo ""
	@echo "$(BLUE)Run 'make -f Makefile.testing help' for all 40+ available commands$(RESET)"
