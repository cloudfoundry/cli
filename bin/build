#!/bin/bash

set -e

echo -e "\nGenerating Binary..."

ROOT_DIR=$(cd $(dirname $(dirname $0)) && pwd)

$ROOT_DIR/bin/generate-language-resources

CLI_GOPATH=$ROOT_DIR/tmp/cli_gopath
rm -rf $CLI_GOPATH
mkdir -p $CLI_GOPATH/src/github.com/cloudfoundry/
ln -s $ROOT_DIR $CLI_GOPATH/src/github.com/cloudfoundry/cli

GODEP_GOPATH=$ROOT_DIR/Godeps/_workspace

sha=`git rev-parse --short HEAD`
version=`cat ${ROOT_DIR}/VERSION`
date=`date -u +"%Y%m%dT%H%M"`
ldflags="-X github.com/cloudfoundry/cli/cf.Version=${version}+${sha} -X github.com/cloudfoundry/cli/cf.BuiltOnDate=${date}"

GOPATH=$CLI_GOPATH:$GODEP_GOPATH:$GOPATH go build -ldflags "${ldflags}" -o $ROOT_DIR/out/cf ./main
rm -rf $CLI_GOPATH
